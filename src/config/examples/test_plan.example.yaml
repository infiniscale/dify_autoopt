# æµ‹è¯•è®¡åˆ’ç¤ºä¾‹æ–‡ä»¶
#
# ä½¿ç”¨æ–¹æ³•ï¼š
# 1. å¤åˆ¶æ­¤æ–‡ä»¶å¹¶é‡å‘½å
#    cp config/examples/test_plan.example.yaml config/test_plan.yaml
# 2. æ ¹æ®ä½ çš„æµ‹è¯•éœ€æ±‚ä¿®æ”¹é…ç½®
# 3. ç¡®ä¿å¼•ç”¨çš„ workflow catalog_id åœ¨ workflow_catalog.yaml ä¸­å­˜åœ¨
# 4. è®¾è®¡æµ‹è¯•æ•°æ®é›†å’Œ Prompt ä¼˜åŒ–å˜ä½“

meta:
  plan_id: "regression_test_2025_q1"     # æµ‹è¯•è®¡åˆ’å”¯ä¸€ ID
  owner: "qa_team"                        # è´Ÿè´£äºº/å›¢é˜Ÿ
  description: "2025å¹´ç¬¬ä¸€å­£åº¦å›å½’æµ‹è¯•è®¡åˆ’"
  created_at: "2025-11-13"
  priority: "high"                        # low | medium | high | critical

# è¦æµ‹è¯•çš„ Workflow åˆ—è¡¨
workflows:
  # ===== ç¤ºä¾‹ 1: å®Œæ•´é…ç½®ï¼ˆå¸¦ Prompt ä¼˜åŒ–ï¼‰ =====
  - catalog_id: "customer_service_bot_v1"  # å¿…é¡»åŒ¹é… workflow_catalog.yaml ä¸­çš„ id
    enabled: true                          # æ˜¯å¦å¯ç”¨æ­¤ workflow
    weight: 1.0                            # æƒé‡ï¼ˆç”¨äºé‡‡æ ·/ä¼˜å…ˆçº§ï¼‰

    # ç»‘å®šçš„æ•°æ®é›†ï¼ˆå¼•ç”¨ test_data.datasets[].nameï¼‰
    dataset_refs:
      - "normal_customer_queries"
      - "edge_case_queries"

    # Prompt ä¼˜åŒ–å˜ä½“ï¼ˆç”¨äº A/B æµ‹è¯•ï¼‰
    prompt_optimization:
      # --- åŸºçº¿ç‰ˆæœ¬ ---
      - variant_id: "baseline"
        description: "åŸå§‹ Promptï¼ˆä¸åšä¿®æ”¹ï¼‰"
        weight: 0.3                        # 30% çš„æµ‹è¯•ç”¨ä¾‹ä½¿ç”¨æ­¤å˜ä½“
        nodes: []                          # ç©ºåˆ—è¡¨è¡¨ç¤ºä¸åšä»»ä½•ä¿®æ”¹

      # --- ä¼˜åŒ–ç‰ˆæœ¬ 1: æ¨¡æ¿æ›¿æ¢ ---
      - variant_id: "enhanced_v1"
        description: "ä½¿ç”¨æ¨¡æ¿ä¼˜åŒ–çš„å‹å¥½ç‰ˆæœ¬"
        weight: 0.4                        # 40% çš„æµ‹è¯•ç”¨ä¾‹
        fallback_variant: "baseline"       # å¦‚æœåº”ç”¨å¤±è´¥ï¼Œå›é€€åˆ° baseline

        nodes:
          # ä¿®æ”¹ä¸»å¯¹è¯æ¨¡å‹çš„ prompt
          - selector:
              by_id: "llm_main"            # ç²¾ç¡®åŒ¹é…èŠ‚ç‚¹ ID
            strategy:
              mode: "template"             # ä½¿ç”¨æ¨¡æ¿æ¸²æŸ“
              template:
                inline: |
                  ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„{{ role }}ã€‚

                  ç”¨æˆ·èƒŒæ™¯ï¼š
                  - è¯­è¨€åå¥½ï¼š{{ language }}
                  - æœåŠ¡ç­‰çº§ï¼š{{ service_level }}

                  è¯·éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š
                  {{ guidelines }}

                  ç°åœ¨ï¼Œè¯·å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚
                variables:
                  role: "å®¢æˆ·æœåŠ¡ä¸“å‘˜"
                  language: "ç®€ä½“ä¸­æ–‡"
                  service_level: "VIP"
                  guidelines: |
                    1. å‹å¥½ä¸”ä¸“ä¸š
                    2. ç®€æ´æ˜äº†
                    3. æä¾›å¯æ“ä½œçš„å»ºè®®

      # --- ä¼˜åŒ–ç‰ˆæœ¬ 2: å‰ç½®/åç½®è¿½åŠ  ---
      - variant_id: "enhanced_v2"
        description: "åœ¨åŸ Prompt å‰åæ·»åŠ æŒ‡ä»¤"
        weight: 0.3                        # 30% çš„æµ‹è¯•ç”¨ä¾‹

        nodes:
          - selector:
              by_id: "llm_main"
            strategy:
              mode: "prepend"              # å‰ç½®è¿½åŠ 
              content: "ã€é‡è¦ã€‘è¯·ç”¨ç®€æ´çš„è¯­è¨€å›ç­”ï¼Œä¸è¶…è¿‡100å­—ã€‚\n\n"

          - selector:
              by_id: "llm_summary"
            strategy:
              mode: "append"               # åç½®è¿½åŠ 
              content: "\n\nè¯·ç¡®ä¿å›ç­”åŒ…å«è¡ŒåŠ¨å»ºè®®ã€‚"

  # ===== ç¤ºä¾‹ 2: ç®€åŒ–é…ç½®ï¼ˆæ—  Prompt ä¼˜åŒ–ï¼‰ =====
  - catalog_id: "content_analyzer_v2"
    enabled: true
    weight: 0.5

    dataset_refs:
      - "sample_articles"

    # ä¸è¿›è¡Œ Prompt ä¼˜åŒ–ï¼Œä½¿ç”¨åŸå§‹é…ç½®
    # prompt_optimization: null

  # ===== ç¤ºä¾‹ 3: å¤šç§ Selector æ–¹å¼ =====
  - catalog_id: "simple_qa_bot"
    enabled: true
    dataset_refs:
      - "qa_pairs"

    prompt_optimization:
      - variant_id: "multi_selector_demo"
        nodes:
          # æŒ‰èŠ‚ç‚¹ç±»å‹åŒ¹é…ï¼ˆåŒ¹é…æ‰€æœ‰ LLM èŠ‚ç‚¹ï¼‰
          - selector:
              by_type: "llm"
              constraints:
                if_missing: "skip"         # å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œè·³è¿‡è€Œä¸æŠ¥é”™
            strategy:
              mode: "replace"
              content: "ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„AIåŠ©æ‰‹ã€‚"

          # æŒ‰æ ‡ç­¾æ¨¡ç³ŠåŒ¹é…
          - selector:
              by_label: "åˆ†æ"             # åŒ¹é…æ ‡ç­¾åŒ…å«"åˆ†æ"çš„èŠ‚ç‚¹
            strategy:
              mode: "prepend"
              content: "è¯·è¿›è¡Œè¯¦ç»†åˆ†æï¼š\n"

          # æŒ‰è·¯å¾„ç›´æ¥æŒ‡å®š
          - selector:
              by_path: "/graph/nodes/0"
            strategy:
              mode: "replace"
              content: "ç‰¹å®šèŠ‚ç‚¹çš„ Prompt"

# æµ‹è¯•æ•°æ®é…ç½®
test_data:
  # æ•°æ®é›†å®šä¹‰
  datasets:
    # ===== ç¤ºä¾‹ 1: å‚æ•°åŒ–è¾“å…¥ï¼ˆç”¨äº Workflowï¼‰ =====
    - name: "normal_customer_queries"
      scenario: "normal"                   # normal | boundary | error | custom
      description: "æ­£å¸¸å®¢æˆ·å’¨è¯¢åœºæ™¯"

      # å‚æ•°åŒ–è¾“å…¥
      parameters:
        # å­—ç¬¦ä¸²å‚æ•°
        query:
          type: "string"
          values:
            - "å¦‚ä½•é‡ç½®å¯†ç ï¼Ÿ"
            - "ä½ ä»¬çš„è¥ä¸šæ—¶é—´æ˜¯ï¼Ÿ"
            - "æˆ‘çš„è®¢å•ä»€ä¹ˆæ—¶å€™å‘è´§ï¼Ÿ"
            - "å¦‚ä½•ç”³è¯·é€€æ¬¾ï¼Ÿ"

        # æ•´æ•°å‚æ•°
        user_id:
          type: "int"
          range:
            min: 1
            max: 1000
            step: 1                        # å¯é€‰ï¼Œé»˜è®¤ 1

        # æšä¸¾å‚æ•°
        user_type:
          type: "enum"
          values: ["free", "basic", "premium", "vip"]

      # Pairwise ç»´åº¦ï¼ˆæŒ‡å®šå“ªäº›å‚æ•°å‚ä¸ç»„åˆæµ‹è¯•ï¼‰
      pairwise_dimensions:
        - "query"
        - "user_type"

      weight: 1.0

    # ===== ç¤ºä¾‹ 2: è¾¹ç•Œæƒ…å†µ =====
    - name: "edge_case_queries"
      scenario: "boundary"
      description: "è¾¹ç•Œå’Œå¼‚å¸¸è¾“å…¥"

      parameters:
        query:
          type: "string"
          values:
            - ""                           # ç©ºè¾“å…¥
            - "a"                          # å•å­—ç¬¦
            - "x" * 10000                  # è¶…é•¿è¾“å…¥ï¼ˆ10kå­—ç¬¦ï¼‰
            - "ç‰¹æ®Šå­—ç¬¦ï¼š<>&\"'\n\t"        # ç‰¹æ®Šå­—ç¬¦
            - "ä¸­è‹±æ··åˆ with emoji ğŸ˜Š"      # å¤šè¯­è¨€

        user_id:
          type: "int"
          values: [0, -1, 999999]          # è¾¹ç•Œå€¼

      weight: 0.5                          # é™ä½æƒé‡ï¼Œå‡å°‘æµ‹è¯•ç”¨ä¾‹

    # ===== ç¤ºä¾‹ 3: Chatflow å¯¹è¯æµ =====
    - name: "multi_turn_conversations"
      scenario: "normal"
      description: "å¤šè½®å¯¹è¯åœºæ™¯ï¼ˆç”¨äº Chatflowï¼‰"

      # Chatflow å¯¹è¯æµ
      conversation_flows:
        # æµç¨‹ 1: å¯†ç é‡ç½®
        - title: "å¯†ç é‡ç½®åœºæ™¯"
          metadata:
            user_type: "premium"
          steps:
            - role: "user"
              message: "æˆ‘å¿˜è®°å¯†ç äº†"
              wait_for_response: true

            - role: "user"
              message: "æˆ‘çš„é‚®ç®±æ˜¯ user@example.com"
              wait_for_response: true

            - role: "user"
              message: "è°¢è°¢"
              wait_for_response: true

        # æµç¨‹ 2: è®¢å•æŸ¥è¯¢
        - title: "è®¢å•çŠ¶æ€æŸ¥è¯¢"
          metadata:
            user_type: "vip"
          steps:
            - role: "user"
              message: "æˆ‘è¦æŸ¥è¯¢è®¢å•çŠ¶æ€"
              wait_for_response: true

            - role: "user"
              message: "è®¢å•å·æ˜¯ #12345"
              wait_for_response: true

      weight: 1.0

    # ===== ç¤ºä¾‹ 4: æ–‡ç« åˆ†ææ•°æ® =====
    - name: "sample_articles"
      scenario: "normal"

      parameters:
        content:
          type: "string"
          values:
            - "è¿™æ˜¯ä¸€ç¯‡å…³äºäººå·¥æ™ºèƒ½çš„æ–‡ç« ..."
            - "ä»Šæ—¥è‚¡å¸‚å¤§æ¶¨ï¼ŒæŠ•èµ„è€…æƒ…ç»ªé«˜æ¶¨..."

        language:
          type: "enum"
          values: ["zh-CN", "en-US"]

      pairwise_dimensions:
        - "content"
        - "language"

  # ç»„åˆç­–ç•¥é…ç½®
  strategy:
    pairwise_mode: "PICT"                  # PICT | IPO | naive
    sampling_method: "weighted"            # weighted | random | stratified
    max_cases_per_variant: 100             # æ¯ä¸ªå˜ä½“æœ€å¤šç”Ÿæˆçš„ç”¨ä¾‹æ•°

# æ‰§è¡Œç­–ç•¥é…ç½®
execution:
  # å¹¶å‘æ§åˆ¶
  concurrency: 5                           # å¹¶è¡Œæ‰§è¡Œçš„ä»»åŠ¡æ•°
  batch_size: 10                           # æ‰¹æ¬¡å¤§å°

  # é€Ÿç‡æ§åˆ¶
  rate_control:
    per_minute: 100                        # æ¯åˆ†é’Ÿæœ€å¤šè¯·æ±‚æ•°
    burst: 20                              # çªå‘è¯·æ±‚æ•°

  # å»¶è¿Ÿå’Œå›é€€
  backoff_seconds: 2.0                     # è¯·æ±‚é—´éš”ï¼ˆç§’ï¼‰

  # é‡è¯•ç­–ç•¥
  retry_policy:
    max_attempts: 3                        # æœ€å¤§é‡è¯•æ¬¡æ•°
    backoff_seconds: 2.0                   # åˆå§‹å›é€€æ—¶é—´
    backoff_multiplier: 1.5                # å›é€€å€æ•°ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
    retry_on_errors:                       # å“ªäº›é”™è¯¯éœ€è¦é‡è¯•
      - "timeout"
      - "rate_limit"
      - "server_error"

  # åœæ­¢æ¡ä»¶
  stop_conditions:
    max_failures: 10                       # æœ€å¤§å¤±è´¥æ•°
    timeout_minutes: 60                    # æ€»è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
    min_success_rate: 0.9                  # æœ€ä½æˆåŠŸç‡ï¼ˆ0-1ï¼‰

# éªŒè¯è§„åˆ™
validation:
  # è¾“å‡ºæ ¼å¼æ£€æŸ¥
  output_format_check: true

  # å“åº”é•¿åº¦é™åˆ¶
  min_response_length: 10                  # æœ€å°å“åº”é•¿åº¦ï¼ˆå­—ç¬¦ï¼‰
  max_response_length: 5000                # æœ€å¤§å“åº”é•¿åº¦

  # å…³é”®è¯æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
  # required_keywords: ["å»ºè®®", "å¸®åŠ©"]
  # forbidden_keywords: ["é”™è¯¯", "å¤±è´¥"]

  # è‡ªå®šä¹‰éªŒè¯å™¨ï¼ˆå¯é€‰ï¼‰
  # custom_validators:
  #   - name: "sentiment_check"
  #     type: "python"
  #     script: "validators/sentiment.py"

# è¾“å‡ºé…ç½®
outputs:
  # æŠ¥å‘Šæ ¼å¼
  report_format: "json"                    # json | html | markdown

  # æ˜¯å¦ä¿å­˜ä¸­é—´ç»“æœ
  save_intermediate: true

  # åˆ¶å“ç›®å½•
  artifacts_dir: "./output/artifacts"

  # è¯¦ç»†ç¨‹åº¦
  verbosity: "normal"                      # minimal | normal | detailed

  # å¯¼å‡ºé€‰é¡¹
  export_options:
    include_metadata: true
    include_timings: true
    include_prompts: false                 # æ˜¯å¦åŒ…å«å®é™… Promptï¼ˆæ•æ„Ÿï¼‰

# ===== ä½¿ç”¨æç¤º =====
#
# 1. Dataset å¼•ç”¨ï¼š
#    workflows[].dataset_refs å¿…é¡»åŒ¹é… test_data.datasets[].name
#
# 2. Variant å¼•ç”¨ï¼š
#    fallback_variant å¿…é¡»å¼•ç”¨åŒä¸€ workflow ä¸­å·²å®šä¹‰çš„ variant_id
#
# 3. Selector ä¼˜å…ˆçº§ï¼š
#    by_path > by_id > (by_label + by_type)
#
# 4. Strategy Modeï¼š
#    - replace: å®Œå…¨æ›¿æ¢
#    - prepend: å‰ç½®è¿½åŠ 
#    - append: åç½®è¿½åŠ 
#    - template: ä½¿ç”¨ Jinja2 æ¨¡æ¿
#
# 5. Pairwise è¯´æ˜ï¼š
#    åªæœ‰ pairwise_dimensions ä¸­çš„å‚æ•°ä¼šè¿›è¡Œç»„åˆï¼Œå…¶ä»–å‚æ•°ä½¿ç”¨ç¬¬ä¸€ä¸ªå€¼
#
# 6. Weight è¯´æ˜ï¼š
#    weight ç”¨äºåŠ æƒé‡‡æ ·ï¼Œå€¼è¶Šå¤§ï¼Œè¢«é€‰ä¸­çš„æ¦‚ç‡è¶Šé«˜
