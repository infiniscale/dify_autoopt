# 项目开发计划（螺旋模型）

> 项目：dify_autoopt
> 文档目的：记录当前完成度与待办，基于螺旋模型制定迭代计划与测试计划，指导后续交付。

## 一、范围与目标
- 目标：提供可运行的“测试/优化/报告”一体化 CLI 工具，具备稳定的执行器、优化器、配置与采集能力，并有完善的日志与测试体系。
- 范围：`src/optimizer/`、`src/executor/`、`src/collector/`、`src/config/` 现有能力整合与打通主入口；补齐最小可用的 `workflow/` 与 `report/`；完善日志模块；补齐依赖与 CI；建立覆盖率与质量门禁。

## 二、现状快照（完成/未完成）
- 已完成
  - 优化器：提示词提取/分析/优化/版本管理与门面 API；接口与文档完善；大量单测。
  - 执行器：并发执行、任务调度、限流、清单构建、用例生成、结果转换等分期组件；单测齐全。
  - 配置系统：Pydantic 模型、Loader/Validator、YAML 解析工具；单测与示例完善。
  - 采集器：数据收集、Excel 导出、分类；含性能与并发相关测试。
  - 仓库结构与文档：模块 README、`docs/` 文档体系完整。
- 未完成/差距
  - 入口程序：`src/main.py` 为演示版，无 `--mode test|optimize|report` CLI 分发；导入不存在的 `yaml_loader`；调用未实现日志方法。
  - 日志模块：实现仅含 `setup_logging/get_logger/log_context/log_performance`，文档/示例中使用的 `log_exception/log_workflow_trace/get_logger_with_context/_log_manager.set_global_context/get_stats` 未实现。
  - 工作流/报告：`workflow/`、`report/` 仅 README，无可调用实现与主程序对接。
  - 依赖：`auth/login.py` 依赖 `requests`、`apscheduler`，`requirements.txt` 未声明。
  - CI：缺少 Python 测试/格式化流水线与覆盖率门禁。
  - 工具链：缺少 `pyproject.toml` 中的 `black/ruff` 配置与 CI 集成。

## 三、约束与风险
- 约束：
  - 不应将敏感凭据写入代码/配置；通过 `.env` 与环境变量管理。
  - 单测不得访问真实 Dify 端点；需使用 stub/fake。
- 主要风险与缓解：
  - 文档与实现不一致导致使用失败 → 优先收敛入口与日志 API，提供最小可用闭环与示例。
  - 外部依赖变动与网络不稳定 → 引入重试与可配置超时，测试中隔离网络。
  - 模块集成复杂 → 分阶段小步迭代，每轮交付可验证产物与回滚方案。

## 四、螺旋模型迭代计划

> 每一轮包含：目标/约束识别 → 风险评估 → 开发与验证 → 计划下一轮。

### 迭代 0：稳定化与可运行骨架（T+1 周）
- 目标：打通最小可运行链路，统一入口/日志/依赖/CI。
- 交付物：
  - 主入口 CLI：`--mode {test,optimize,report}` 与通用参数；使用 `src/config/loaders` 替代 `yaml_loader`。
  - 日志最小补齐：提供简版 `@log_exception`、`log_workflow_trace` 与全局上下文/统计占位实现，或调整示例仅用已实现 API。
  - 依赖修正：在 `requirements.txt` 增加 `requests`、`APScheduler`。
  - CI 基线：GitHub Actions 安装依赖、`ruff`、`black --check`、`pytest --cov`。
- 验证：
  - 本地运行三种模式的最小流程（可输出 stub/示例结果）。
  - 单测通过并产出覆盖率报告。
- 风险&缓解：
  - 入口改动影响广 → 渐进式提交，保持向后兼容。

### 迭代 1：功能闭环（T+2 周）
- 目标：完成“测试/优化/报告”的基本业务闭环与模块间对接。
- 交付物：
  - `workflow/`：`discovery.py`、`runner.py` 最小实现，能从 Catalog 选择工作流并驱动执行器。
  - `report/`：基于 Collector 输出生成简版报告（JSON/Excel 二选一）。
  - `main.py` 模式分发接入执行器/优化器/采集器/报告。
- 验证：
  - 端到端 E2E 测试（使用 stub/workflow 样例，无真实网络）。
  - 错误路径测试（配置缺失、执行失败、超时、速率限制）。
- 风险&缓解：
  - 集成复杂 → 对外暴露稳定门面，内部通过依赖注入解耦。

### 迭代 2：健壮性与可观测性（T+2 周）
- 目标：增强稳定性、性能与可观测性。
- 交付物：
  - 日志增强：结构化字段、上下文传播、关键路径性能埋点、统计接口。
  - 工作流发现/报告能力扩展（标签筛选、指标维度拓展）。
  - 失败重试、速率/并发策略验证与压测脚本（stub）。
- 验证：
  - 并发/性能基准；日志与错误追踪的可追溯性用例。
  - 覆盖率门槛 ≥ 80%，关键模块 ≥ 85%。

### 迭代 3：发布与文档对齐（T+1 周）
- 目标：对齐文档与实现，完善配置示例，准备发布。
- 交付物：
  - `README` 与模块文档更新，增加操作指南与故障排除。
  - `config/examples/` 提供 env/catalog/plan 的可运行样例。
  - 发布清单与回滚方案；变更日志。
- 验证：
  - CI 全绿；质量门禁（lint、格式化、覆盖率）满足基线。

## 五、工作分解（WBS，按迭代）
- 迭代 0
  - CLI 骨架与参数解析
  - 替换配置导入链路（`ConfigLoader/Validator`）
  - 日志最小补齐或示例调整
  - 依赖与 CI（ruff/black/pytest-cov）
- 迭代 1
  - `workflow.discovery/runner` 最小实现
  - `report` 简报导出
  - `main.py` 模式分发整合
  - E2E 与错误路径测试
- 迭代 2
  - 日志增强与指标统计
  - 工作流筛选与报告维度扩展
  - 并发/性能测试与稳态策略
- 迭代 3
  - 文档/样例对齐
  - 发布流程与门禁强化

## 六、测试计划
- 策略
  - 分层测试：单元 → 组件/集成 → 端到端 → 非功能（并发/性能/稳健性）。
  - 隔离外部依赖：通过 stub/fake，禁止真实网络与真实 Dify 调用。
  - 风险驱动：对入口整合、并发执行、日志/采集路径与配置加载优先覆盖。
- 覆盖率目标
  - 基线：全局 ≥ 80%；关键模块（executor、optimizer、config.loader/validator、logger）≥ 85%。
- 用例类型
  - 单元：模型校验、加载/校验器、执行器调度/限流、优化策略、日志格式化与装饰器。
  - 组件/集成：执行器+采集器流水、优化器+版本存储、配置跨文件引用校验。
  - E2E：`--mode test|optimize|report` 串起最小闭环（使用样例 catalog 与 stub）。
  - 错误路径：配置缺失/格式错误、网络异常（模拟）、超时/重试、队列积压、磁盘写失败（模拟）。
  - 非功能：并发 10/50/100 压力下的吞吐与延迟、日志写入开销评估。
- 测试数据与环境
  - 使用 `config/examples/` 提供 env/catalog/plan 示例；`.env.example` 指引本地变量。
  - 临时目录与内存存储，避免真实 I/O；pytest fixtures 统一注入。
- 工具与流水线
  - `pytest`/`pytest-cov`、`ruff`、`black`；GitHub Actions 集成安装依赖并执行覆盖率与格式检查。
- 进入/退出准入
  - 进入：模块接口稳定、样例配置可用、关键路径打桩完成。
  - 退出：CI 全绿、覆盖率达标、关键 E2E 与错误路径通过、文档与实现一致。

## 七、完成判定（DoD）
- CLI 三模式可运行并输出预期产物（允许 stub）。
- 单测通过且覆盖率达标；关键错误路径覆盖。
- 日志结构化字段与上下文在关键路径可追踪。
- 文档、示例、配置与实现一致；CI 门禁生效。

## 八、变更与发布流程
- 分支：Git Flow（feature/fix/hotfix），`.claude/hooks/` 维持规范。
- 提交与 PR：小步提交，PR 附目的/测试计划/截图（报告类）。
- 发布：拟定 Release Notes 与回滚方案，必要时打 Tag。

## 九、开放问题（跟踪）
- `workflow/` 与 `report/` 的最小接口定义需敲定（Runner 输入/输出契约）。
- 日志模块究竟补齐哪些 API 与语义范围（与示例对齐），或统一下调示例范围。
- 优化器 LLM 直连与成本控制是否在短期纳入 E2E（当前建议仅 stub）。

## 十、里程碑与时间线（建议）
- 迭代 0：T+1 周 — 可运行骨架与 CI 基线。
- 迭代 1：T+2 周 — 功能闭环与 E2E。
- 迭代 2：T+2 周 — 健壮性、性能与可观测性。
- 迭代 3：T+1 周 — 文档与发布。

— 完 —

